<!Doctype html>
<html>

<head>
    <meta charset="utf-8">

    <title>Home</title>

    <!-- Bootstrap core CSS -->


    <style>
    </style>
    
    <link
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
	rel="stylesheet"></link>
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/jquery.smartmenus/1.1.0/addons/bootstrap/jquery.smartmenus.bootstrap.min.css"
	rel="stylesheet"></link>
<script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
<script
	src='https://cdnjs.cloudflare.com/ajax/libs/jquery.smartmenus/1.1.0/jquery.smartmenus.min.js'></script>
<script
	src='https://cdnjs.cloudflare.com/ajax/libs/jquery.smartmenus/1.1.0/addons/bootstrap/jquery.smartmenus.bootstrap.min.js'></script>
    
    
    <!-- Custom styles for this template -->
    <link rel="stylesheet" href="statics/css/navbar.css">
    <link rel="stylesheet" href="statics/css/themebox.css">
    <link rel="stylesheet" href="statics/css/card.css">
    <link rel="stylesheet" href="statics/css/product.css">

    <script src="statics/js/jquery-3.4.1.min.js"></script>
</head>

<body bgcolor="#BCE2FF">

    <ul class="navbar">
        <li class="navbar"><a href="index.html"><img src="statics/img/navbar/icon.png" style="float: left"
                    height="100px" width="100px"></img></a></li>
        <li class="navbar"><a class="navbarItem" href="index.html">Home</a></li>
        <li class="navbar"><a class="navbarItem" href="productIndex.html">商品總覽</a></li>
        <li class="navbar"><a class="navbarItem" href="order_tracking.html">訂單追蹤</a></li>
        <li class="navbar"><a class="navbarItem" href="shoppingcart.html">購物車</a></li>
        <li class="navbar"><a id="myMarket" class="navbarItem" href="my_market.html">我的賣場</a></li>
        <li id="signup_in" style="float: right"><a class="navbarItemSide" href="login_selected.html">會員註冊/登入</a></li>

        <div id="member_center1" class="mediumbox" style="float: right">
            <li style="float: left"><a id="member_center" class="navbarFloating" href="member_change.html">會員中心</a></li>
            <li style="float: left"><a id="remove" class="navbarFloating" href="index.html">&nbsp;登出 </a></li>
            <li style="float: left">

        </div>
        <div id="member_center2" class="smallbox" style="float: right">
            <li><img src="statics/img/navbar/shoppingcart.png" style="float: left" height="20px" width="20px"></img>
            </li>
            <li><a class="navbarFloating" href="shoppingcart.html">購物車</a></li>
        </div>
        <div id="member_center3" class="smallbox" style="float: right">
            <li><img src="statics/img/navbar/user.png" style="float: left" height="20px" width="20px"></img></li>
            <li id="user_name" class="navbarFloating">user</li>
        </div>
    </ul>
    <div class="frame">

        <div class="generalbox">
        <p>商品目錄</p>
            <!--下拉選單-->
			<div class="navbar-collapse collapse">
				<ul class="nav navbar-nav">
					<li><a href="#">篩選項目<span class="caret"></span></a>
						<ul class="dropdown-menu">
							<li><a href="#">男人館<span class="caret"></span></a>
								<ul class="dropdown-menu">
									<li><a id="man_winter" href="#">秋冬季衣著</a></li>
									<li><a id="man_summer"href="#">春夏季衣著</a></li>
									<li><a id="man_exercise"href="#">運動休閒類型</a></li>
									<li><a id="man_suit"href="#">西裝/套裝</a></li>
									<li><a id="man_child"href="#">童裝</a></li>
									<li><a id="man_socks"href="#">襪子</a></li>
									<li><a id="man_shoes"href="#">鞋子</a></li>
									<li><a id="man_accessories"href="#">配件</a></li>
								</ul></li>
							<li><a href="#">女人館<span class="caret"></span></a>
								<ul class="dropdown-menu">
									<li><a id="woman_winter" href="#">秋冬季衣著</a></li>
									<li><a id="woman_summer" href="#">春夏季衣著</a></li>
									<li><a id="woman_exercise" href="#">運動休閒類型</a></li>
									<li><a id="woman_suit" href="#">西裝/套裝</a></li>
									<li><a id="woman_child" href="#">童裝</a></li>
									<li><a id="woman_socks" href="#">襪子</a></li>
									<li><a id="woman_shoes" href="#">鞋子</a></li>
									<li><a id="woman_accessories" href="#">配件</a></li>
								</ul></li>
							<li><a href="#">兒童館<span class="caret"></span></a>
								<ul class="dropdown-menu">
									<li><a href="#">秋冬季衣著</a></li>
									<li><a href="#">春夏季衣著</a></li>
									<li><a href="#">運動休閒類型</a></li>
									<li><a href="#">西裝/套裝</a></li>
									<li><a href="#">童裝</a></li>
									<li><a href="#">襪子</a></li>
									<li><a href="#">鞋子</a></li>
									<li><a href="#">配件</a></li>
								</ul></li>
						</ul></li>
				</ul>
			</div>
			<!--下拉選單-->
            
          	 	 <div class="album py-5 bg-light">
					<p>篩選商品</p>
                	<div class="container">
                  		<div id="filter_product_panel" class="row"></div>
                	</div>
            	</div>
            	 <div class="album py-5 bg-light">
					<p>熱賣商品</p>
                	<div class="container">
                  		<div id="hot_product_panel" class="row"></div>
                	</div>
            	</div>
            	<div class="album py-5 bg-light">
					<p>新商品</p>
                	<div class="container">
                  		<div id="new_product_panel" class="row"></div>
                	</div>
            	</div>
                <div class="album py-5 bg-light">
					<p>平價商品</p>
                	<div class="container">
                  		<div id="parity_product_panel" class="row"></div>
                	</div>
            	</div>
            	<div class="album py-5 bg-light">
					<p>男人館</p>
                	<div class="container">
                  		<div id="man_product_panel" class="row"></div>
                	</div>
            	</div>
            	<div class="album py-5 bg-light">
					<p>女人館</p>
                	<div class="container">
                  		<div id="woman_product_panel" class="row"></div>
                	</div>
            	</div>
            	<div class="album py-5 bg-light">
					<p>兒童館</p>
                	<div class="container">
                  		<div id="child_product_panel" class="row"></div>
                	</div>
            	</div>
        </div>

    </div>



    <script type="text/javascript">
        var [client_cart_obj, client_cart_amount] = getCartDataFromClient();


        function getisSellerFromClient() {
            let isSeller = JSON.parse(localStorage.getItem("client_isSeller"));

            isSeller = !isSeller ? new Array() : isSeller;

            return [isSeller];
        }
        /*--------------GET各種類型的商品--------------*/
        function getAllProduct() {
            $.ajax({
                type: "GET",
                url: "api/product.do",
                crossDomain: true,
                cache: false,
                dataType: 'json',
                timeout: 5000,
                success: function (response) {
                    if (response.status == 200) {
                        var parity_product_panel = '';
                        var man_product_panel = '';
                        var woman_product_panel = '';
                        var child_product_panel = '';
                        var new_product_panel = '';
                      
                        

                        $.each(response.response.data, function () {
                        	if(this.price<=500)
                    		{
                        		parity_product_panel += addProduct(this);
                			}
                        	if(this.type=="男人館")
                    		{
                        		man_product_panel += addProduct(this);
                			}
                        	if(this.type=="女人館")
                    		{
                        		woman_product_panel += addProduct(this);
                			}
                        	if(this.type=="兒童館")
                    		{
                        		child_product_panel += addProduct(this);
                			}
                        	
                        	var dateString = this.created;

                        	var date = new Date(Date.parse(dateString.replace(/-/g,"/")));                       	
                      		var date_year=date.getFullYear();
                      		var date_month=date.getMonth();
                      		var date_day=date.getDay();
                      		var date_hour=date.getHours();
                        	
                        	
                        	
                        	var d = new Date();   
                        	var utcyear =d.getFullYear();
                        	var utcmonth=d.getMonth();
                        	var utcday = d.getDay();
                        	var utchour=d.getHours();
                        	
                        	//時間演算法
                        	if((utcyear-date_year)<=1)
                        		if((utcmonth-date_month)<=0||(utcmonth-date_month)==-11)
                        			if((utcday-date_day)<1||(utcday-date_day)==-30||(utcday-date_day)==-29||(utcday-date_day)==-28||(utcday-date_day)==-27)
                        				if((utchour-date_hour)<=12)
                        				{
                        					new_product_panel += addProduct(this);
                        				}
                        	           
                        })
						
                        $("#parity_product_panel").append(parity_product_panel);
                        $("#man_product_panel").append(man_product_panel);
                        $("#woman_product_panel").append(woman_product_panel);
                        $("#child_product_panel").append(child_product_panel);
                        $("#new_product_panel").append(new_product_panel);
                        setButtonFunction();
                        checkIfExistInCart();
                    }
                    console.log(response);
                },
                error: function () {
                    alert("無法連線到伺服器！");
                }
            });
        }
        function getFilterProduct(type,category) {
            $.ajax({
                type: "GET",
                url: "api/product.do",
                crossDomain: true,
                cache: false,
                dataType: 'json',
                timeout: 5000,
                success: function (response) {
                    if (response.status == 200) {
                    	var filter_product_panel = '';
                      
                        $.each(response.response.data, function () {
                        	
                        	if(type==this.type && category==this.category)
                        	{
                				filter_product_panel += addProduct(this);
                			}
                            
                        })
                        if(filter_product_panel=="")
                        	{
                        		filter_product_panel+="<p>這個選項沒有資料!!</p>";
                        		
                        	}
                        $('#filter_product_panel').empty()
						$("#filter_product_panel").append(filter_product_panel);
                      
                        setButtonFunction();
                        checkIfExistInCart();
                    }
                    console.log(response);
                },
                error: function () {
                    alert("無法連線到伺服器！");
                }
            });
        }
        
        function getHotProduct() {
        	  $.ajax({
                  type: "GET",
                  url: "api/orderProduct.do",
                  crossDomain: true,
                  cache: false,
                  dataType: 'json',
                  timeout: 5000,
                  success: function (response) {
                      if (response.status == 20000) {
                    	  console.log(response);
                          var product_panel = '';

                          $.each(response.response.data, function () {
                              product_panel += addProduct(this);
                          })

                          $("#hot_product_panel").append(product_panel);
                          
                      }
                      console.log(response);
                      
                      
                      
                  },
                  error: function () {
                      alert("無法連線到伺服器！1111");
                  }
              });
           
        }
        
        /*----------------------------------------*/
        //判斷是否是賣家我的賣場
        var [client_isSeller] = getisSellerFromClient();
        $("#myMarket").hide();
        if (parseInt(client_isSeller.toString()) == 1) {
            $("#myMarket").show();
        }

        

        /**
         * 畫出一筆商品
         */
        function addProduct(data) {
            let inner_html = '';
            inner_html += '<div class="col-md-4" style="float:left;">';
            inner_html += '<div class="card-header">';
            inner_html += '<h4 class="font-weight-normal text-center text-truncate">' + data.product_name + '</h4>';
            inner_html += '</div>';
            inner_html += '<div class="card mb-4 shadow-sm">';
            inner_html += '<img src="' + data.image + '" height="200px" width="200px" hspace="50px">';
            inner_html += '<div class="card-body">';
            inner_html += '<h1 class="card-title pricing-card-title">$' + data.price + ' <small class="text-muted">/ USD</small></h1>';
            inner_html += '<p class="card-text">' + data.product_info + '</p>';
            inner_html += '<div class="d-flex justify-content-between align-items-center">';
            inner_html += '<div class="btn-group">';
            inner_html += '<button id="add_cart_' + data.idtbl_product + '" name="add_cart" type="button" class="productcard">加入購物車</button>';
            inner_html += '</div><small class="text-muted">id: ' + data.idtbl_product + '</small>';
            inner_html += '</div></div></div></div>';

            return inner_html;
        }

        function setButtonFunction() {
            $('button[name="add_cart"]').click(function () {
                var action = (this.id).split('_')[0];
                var destination = (this.id).split('_')[1];
                var id = (this.id).split('_')[2];
                addProductToCart(id, 1);
            });
        }

        function getCartDataFromClient() {
            let cart = JSON.parse(localStorage.getItem("client_cart_obj"));
            let amount = JSON.parse(localStorage.getItem("client_cart_amount"));
            cart = !cart ? new Array() : cart;
            amount = !amount ? new Array() : amount;
            return [cart, amount];
        }

        function addProductToCart(id, amount) {
            if (!(client_cart_obj.includes(id))) {
                client_cart_obj.push(id);
                client_cart_amount.push(amount);
                updateCartDataToClent();
            }

            checkIfExistInCart();
        }

        function updateCartDataToClent() {
            localStorage.setItem("client_cart_obj", JSON.stringify(client_cart_obj));
            localStorage.setItem("client_cart_amount", JSON.stringify(client_cart_amount));
        }

        function checkIfExistInCart() {
            $('button[name="add_cart"]').each(function () {
                var action = (this.id).split('_')[0];
                var destination = (this.id).split('_')[1];
                var id = (this.id).split('_')[2];
                if (client_cart_obj.includes(id)) {
                    setButtonState(this.id, false);
                }
                else {
                    setButtonState(this.id, true);
                }

            });
        }

        function setButtonState(id, action) {
            if (!action) {
                $('#' + id).prop('disabled', true);
                $('#' + id).addClass('disabled');
                $('#' + id).html('已加入');
            }
            else {
                $('#' + id).prop('disabled', false);
                $('#' + id).removeClass('disabled');
                $('#' + id).html('加入購物車');
            }
        }


        /*------------登入登出實作member cookie-----------*/

        var [client_id, client_name, client_isSeller] = getMemberDataFromClient();

        function getMemberDataFromClient() {
            let id = JSON.parse(localStorage.getItem("client_id"));
            let name = JSON.parse(localStorage.getItem("client_name"));
            let isSeller = JSON.parse(localStorage.getItem("client_isSeller"));

            id = !id ? new Array() : id;
            name = !name ? new Array() : name;
            isSeller = !isSeller ? new Array() : isSeller;
            return [id, name, isSeller];
        }

        function updateMemberDataToClent() {
            localStorage.setItem("client_id", JSON.stringify(client_id));
            localStorage.setItem("client_name", JSON.stringify(client_name));
            localStorage.setItem("client_isSeller", JSON.stringify(client_isSeller));
            localStorage.setItem("client_cart_obj", JSON.stringify(client_cart_obj));
            localStorage.setItem("client_cart_amount", JSON.stringify(client_cart_amount));

        }
        /*----------------------------------------*/
        
        
        /*------------登入登出實作manager cookie-----------*/

        var [manager_id, manager_name, manager_isLeader] = getManagerDataFromClient();

        function getManagerDataFromClient() {
            let id = JSON.parse(localStorage.getItem("manager_id"));
            let name = JSON.parse(localStorage.getItem("manager_name"));
            let isLeader = JSON.parse(localStorage.getItem("manager_isLeader"));

            id = !id ? new Array() : id;
            name = !name ? new Array() : name;
            isLeader = !isLeader ? new Array() : isLeader;
            return [id, name, isLeader];
        }

        function updateManagerDataToClent() {
            localStorage.setItem("manager_id", JSON.stringify(manager_id));
            localStorage.setItem("manager_name", JSON.stringify(manager_name));
            localStorage.setItem("manager_isLeader", JSON.stringify(manager_isLeader));
        }
        /*----------------------------------------*/
        
        function loguot() {
            client_id = [];
            client_name = [];
            client_isSeller = [];
            updateMemberDataToClent();
            client_cart_obj = [];
            client_cart_amount = [];
        	updateCartDataToClent();//有點奇怪，指呼叫一次的話不能刪乾淨，所以呼叫兩次updateMemberDataToClent
        	manager_id=[];
        	manager_name=[];
        	manager_isLeader=[];
        	updateManagerDataToClent();
            $("#member_center1").hide();
            $("#member_center2").hide();
            $("#member_center3").hide();
            $("#signup_in").show();
            $("#user_name").empty();
        }

        $("#remove").click(function () {
            console.log("[@Action]登出");
            loguot();
        });
       
        
        $(document).ready(function () {
        	getAllProduct();
        	getHotProduct();
         $("#man_winter").click(function () {
        	
        	 var type = "男人館";
        	 var category = "秋冬季衣著";
        	 getFilterProduct(type,category);
        });
         $("#man_summer").click(function () {
         	
        	 var type = "男人館";
        	 var category = "春夏季衣著";
        	 getFilterProduct(type,category);
        });
         $("#man_exercise").click(function () {
          	
        	 var type = "男人館";
        	 var category = "運動休閒類型";
        	 getFilterProduct(type,category);
        });
         $("#man_suit").click(function () {
          	
        	 var type = "男人館";
        	 var category = "西裝/套裝";
        	 getFilterProduct(type,category);
        });
         $("#man_child").click(function () {
          	
        	 var type = "男人館";
        	 var category = "童裝";
        	 getFilterProduct(type,category);
        });
         $("#man_socks").click(function () {
          	
        	 var type = "男人館";
        	 var category = "襪子";
        	 getFilterProduct(type,category);
        });
         $("#man_shoes").click(function () {
          	
        	 var type = "男人館";
        	 var category = "鞋子";
        	 getFilterProduct(type,category);
        });
         $("#man_accessories").click(function () {
          	
        	 var type = "男人館";
        	 var category = "配件";
        	 getFilterProduct(type,category);
        });
         $("#woman_winter").click(function () {
           	
        	 var type = "女人館";
        	 var category = "秋冬季衣著";
        	 getFilterProduct(type,category);
        });
         $("#woman_summer").click(function () {
            	
        	 var type = "女人館";
        	 var category = "春夏季衣著";
        	 getFilterProduct(type,category);
        });
         $("#woman_exercise").click(function () {
         	
        	 var type = "女人館";
        	 var category = "運動休閒類型";
        	 getFilterProduct(type,category);
        });
         $("#woman_suit").click(function () {
          	
        	 var type = "女人館";
        	 var category = "西裝/套裝";
        	 getFilterProduct(type,category);
        });
         $("#woman_child").click(function () {
           	
        	 var type = "女人館";
        	 var category = "童裝";
        	 getFilterProduct(type,category);
        });
         $("#woman_socks").click(function () {
            	
        	 var type = "女人館";
        	 var category = "襪子";
        	 getFilterProduct(type,category);
        });
         $("#woman_shoes").click(function () {
            	
        	 var type = "女人館";
        	 var category = "鞋子";
        	 getFilterProduct(type,category);
        });
         $("#woman_accessories").click(function () {
            	
        	 var type = "女人館";
        	 var category = "配件";
        	 getFilterProduct(type,category);
        });
         
        	if(client_id.length != 0) {//登入會員
                $("#user_name").html(client_name);
                $("#member_center1").show();
                $("#member_center2").show();
                $("#member_center3").show();
                $("#signup_in").hide();
            }else if(manager_id.length != 0) {//登入管理員
                $("#user_name").html(manager_name);
                $("#member_center1").show();
                $("#member_center").hide();//隱藏會員中心
                $("#member_center2").hide();
                $("#member_center3").show();
                $("#signup_in").hide();
            }else { //登出
                $("#member_center1").hide();
                $("#member_center2").hide();
                $("#member_center3").hide();
            } 
        });

    </script>

    <footer class="text-muted">
        <div class="container">
            <p class="float-right">
                <a href="#">Back to top</a>
            </p>
        </div>
    </footer>


</body>

</html>
