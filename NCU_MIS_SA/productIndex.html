<!Doctype html>
<html>

<head>
<meta charset="utf-8">

<title>ProductIndex</title>

<!-- Bootstrap core CSS -->


<style>
   .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
</style>
<!-- Custom styles for this template -->
<link rel="stylesheet" href="statics/css/navbar.css">
<link rel="stylesheet" href="statics/css/themebox.css">
<link rel="stylesheet" href="statics/css/card.css">
<link rel="stylesheet" href="statics/css/product.css">

<script src="statics/js/jquery-3.4.1.min.js"></script>
</head>

<body bgcolor="#BCE2FF">

	<ul class="navbar">
		<li class="navbar"><a href="index.html"><img src="statics/img/navbar/icon.png" style="float: left" height="100px" width="100px" ></img></a></li>
		<li class="navbar"><a class="navbarItem" href="index.html">Home</a></li>
		<li class="navbar"><a class="navbarItem" href="productIndex.html">商品總覽</a></li>
		<li class="navbar"><a class="navbarItem"
			href="order_tracking.html">訂單追蹤</a></li>
		<li class="navbar"><a class="navbarItem" href="shoppingcart.html">購物車</a></li>
		<li style="float: right"><a class="navbarItemSide" href="login_selected.html">會員註冊/登入</a></li>
	</ul>

	<div class="frame">
		
		<div class="generalbox">
		<p>商品目錄</p>
			<div class="album py-5 bg-light">
			    <div class="container">
			      <div id="product_panel" class="row">
			      </div>
			    </div>
			</div>		
		</div>
	
	</div>



	<script>   
	/**
	 * 進入網頁時，先去 cookie 裡面找有無暫存資料，並把此暫存資料存到二維陣列中。
     * 設定一個二維陣列：[商品編號,商品數量]。
     * @call：getCartDataFromClient()：
     */
    var [client_cart_obj, client_cart_amount]  = getCartDataFromClient();
    
    /**
     * 取得所有商品
     * @call：addProduct()：畫出一筆商品
     * @call：setButtonFunction()：按鈕設置
     * @call：checkIfExistInCart()：
     */
    function getAllProduct() {
      $.ajax({
        type: "GET",
        url: "api/product.do",
        crossDomain: true,
        cache: false,
        dataType: 'json',
        timeout: 5000,
        success: function (response) {
          if (response.status == 200) {
        	var product_panel = '';
        	
        	$.each(response.response.data, function (){
        		product_panel += addProduct(this);
        	})
        	
        	$("#product_panel").append(product_panel);
        	setButtonFunction();
        	checkIfExistInCart();
          }
        },
        error: function () {
          alert("無法連線到伺服器！");
        }
      });
    }

    getAllProduct();
    
    /**
     * 畫出一筆商品
     */
    function addProduct(data) {
    	let inner_html = '';
    	inner_html += '<div class="col-md-4" style="float:left;">';
   		inner_html += '<div class="card-header">';
   		inner_html += '<h4 class="font-weight-normal text-center text-truncate">' + data.product_name + '</h4>';
 		inner_html += '</div>';
 		inner_html += '<div class="card mb-4 shadow-sm">';
 		inner_html += '<img src="' + data.image + '" width="100%">';
		inner_html += '<div class="card-body">';
		inner_html += '<h1 class="card-title pricing-card-title">$' + data.price +' <small class="text-muted">/ USD</small></h1>';
		inner_html += '<p class="card-text">' + data.product_info + '</p>';
		inner_html += '<div class="d-flex justify-content-between align-items-center">';
		inner_html += '<div class="btn-group">';
		inner_html += '<button id="add_cart_' + data.idtbl_product + '" name="add_cart" type="button" class="productcard">加入購物車</button>';
		inner_html += '</div><small class="text-muted">id: '+ data.idtbl_product + '</small>';
		inner_html += '</div></div></div></div>';
    	
		return inner_html;
    }
    
    /**
     * 按鈕設置：如果按了，就新增一筆資料到 cookie
     * 當按下任意一個「加入購物車」的按鈕後：呼叫addProductToCart()，把此商品加入購物車。
     * @call：addProductToCart()：
     */
    function setButtonFunction() {
    	$('button[name="add_cart"]').click(function () {
    		var action = (this.id).split('_')[0];
    		var destination = (this.id).split('_')[1];
    		var id = (this.id).split('_')[2];
    		addProductToCart(id, 1);
        });
    }
    
    /**
     * 從 Client 端的 localstorage 取回儲存於購物車資訊
     */
    function getCartDataFromClient() {
    	let cart = JSON.parse(localStorage.getItem("client_cart_obj"));
    	let amount = JSON.parse(localStorage.getItem("client_cart_amount"));
    	cart = !cart ? new Array() : cart;
    	amount = !amount ? new Array() : amount;
    	return [cart, amount];
    }
    
    /**
     * 新增一筆 cookie 
     * 將此商品加入購物車：如果還沒買過此商品 ( 即 client_cart_obj 內沒有此id)，就新增一筆，就把此商品存放到 cookie [client_cart_obj,client_cart_amount]
     * @call：updateCartDataToClent()：上傳二維陣列到 cookie 中
     * @call：checkIfExistInCart()：
     */
    function addProductToCart(id, amount) {
    	if (!(client_cart_obj.includes(id))) {
    		client_cart_obj.push(id);
    		client_cart_amount.push(amount);
    		updateCartDataToClent();
    	}
    	checkIfExistInCart();
    }
    
    /**
     * 更新購物車資料到 localstorage
     * 把存在二維陣列的資料，上傳到 cookie 中。
     *（localStorage即cookie：刷新頁面後不會消失，會暫存一段時間。相反地，二維陣列再刷新頁面後會消失。所以得把二維陣列裡的資料上傳到localStorage）
     */
    function updateCartDataToClent() {
    	localStorage.setItem("client_cart_obj", JSON.stringify(client_cart_obj));
    	localStorage.setItem("client_cart_amount", JSON.stringify(client_cart_amount));
    }
    
    /**
     * 檢查商品是否已經在購物車當中
     * @call：setButtonState：
     */
    function checkIfExistInCart() {
    	$('button[name="add_cart"]').each(function (){
    		var action = (this.id).split('_')[0];
    		var destination = (this.id).split('_')[1];
    		var id = (this.id).split('_')[2];
    		if (client_cart_obj.includes(id)) {
    			setButtonState(this.id, false);
    		}
    		else {
    			setButtonState(this.id, true);
    		}
    		
        });
    }
    
    /**
     * 設定按鈕狀態
     */
    function setButtonState(id, action) {
    	if (!action) {
    	    $('#' + id).prop('disabled', true);
    	    $('#' + id).addClass('disabled');
    	    $('#' + id).html('已加入');
    	}
    	else {
    		$('#' + id).prop('disabled', false);
    	    $('#' + id).removeClass('disabled');
    	    $('#' + id).html('加入購物車');
    	}
    }
  </script>

	<footer class="text-muted">
		<div class="container">
			<p class="float-right">
				<a href="#">Back to top</a>
			</p>
		</div>
	</footer>


</body>

</html>
