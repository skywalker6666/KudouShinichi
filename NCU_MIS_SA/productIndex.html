<!Doctype html>
<html>

<head>
<meta charset="utf-8">

<title>ProductIndex</title>

<!-- Bootstrap core CSS -->


<style>
.bd-placeholder-img {
	font-size: 1.125rem;
	text-anchor: middle;
	-webkit-user-select: none;
	-moz-user-select: none;
	-ms-user-select: none;
	user-select: none;
}

@media ( min-width : 768px) {
	.bd-placeholder-img-lg {
		font-size: 3.5rem;
	}
}
</style>
<!-- Custom styles for this template -->

<link href="statics/css/bootstrap.min.css" rel="stylesheet">
<script src="statics/js/jquery-3.4.1.min.js"></script>
<script type="text/javascript"
		src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
	<link rel="stylesheet"
		href="http://code.jquery.com/ui/1.9.2/themes/smoothness/jquery-ui.css" />
	<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>

</head>

<body>
	
	<nav class="navbar fixed-top navbar-expand-lg navbar-light "
		style="background-color: #e3f2fd">
		<a class="navbar-brand" href="index.html"><img
			src="statics/img/navbar/icon.png" style="float: left" height="50px"
			width="50px"></img></a>
		<button class="navbar-toggler" type="button" data-toggle="collapse"
			data-target="#navbarColor03" aria-controls="navbarColor03"
			aria-expanded="true" aria-label="Toggle navigation">
			<span class="navbar-toggler-icon"></span>
		</button>

		<div class="navbar-collapse collapse show" id="navbarColor03" style="">
			<ul class="navbar-nav mr-auto">
				<li class="nav-item active"><a class="nav-link"
					href="index.html">Home <span class="sr-only">(current)</span></a></li>
				<li class="nav-item"><a class="nav-link"
					href="productIndex.html">商品總覽</a></li>
				<li class="nav-item" id="track"><a class="nav-link"
					href="order_tracking.html">訂單追蹤</a></li>
				<li class="nav-item" id="shopcart"><a class="nav-link"
					href="shoppingcart.html">購物車</a></li>
				<li class="nav-item" id="mymarket"><a class="nav-link"
					href="my_market.html">我的賣場</a></li>
			</ul>

		</div>

		<ul class="navbar-nav mr-auto">

			<li class="nav-item" id="member_center1"><img
				src="statics/img/navbar/shoppingcart.png" height="20px" width="20px"></img></li>
			<li id="member_center2"><a class="nav-link"
				href="shoppingcart.html">購物車</a></li>


			<li id="signup_in" class="nav-item"><a class="nav-link"
				href="login_selected.html">會員註冊/登入</a></li>

			<li class="nav-item" id="member_center3"><img
				src="statics/img/navbar/user.png" height="20px" width="20px"></img></li>
			<li id="user_name" class="nav-link">user</li>

			<li class="nav-item" id="member_center4"><a id="member_center"
				class="nav-link" href="member_change.html">會員中心</a></li>

			<li class="nav-item" id="member_center5"><a id="remove"
				class="nav-link" href="index.html">&nbsp;登出 </a></li>

		</ul>

		<form class="form-inline">
			<input class="form-control mr-sm-2" type="search"
				placeholder="Search" aria-label="Search">
			<button class="btn btn-outline-primary " type="submit">Search</button>
		</form>
	</nav>
	<div class="frame">

		<div class="generalbox" style="margin-top: 100px">
			<p>商品目錄</p>
			<div class="album py-5 bg-light">
				<div class="container">
					<div id="product_panel" class="row"></div>

				</div>
			</div>
		</div>

		<script>
        /**
         * 進入網頁時，先去 cookie 裡面找有無暫存資料，並把此暫存資料存到二維陣列中。
         * 設定一個二維陣列：[商品編號,商品數量]。
         * @call：getCartDataFromClient()：
         */
         var [client_id]  = getIDFromClient();
        var [client_cart_obj, client_cart_amount] = getCartDataFromClient();

        //判斷是否是賣家我的賣場
        var [client_isSeller] = getisSellerFromClient();
        $("#myMarket").hide();
        if (parseInt(client_isSeller.toString()) == 1) {
            $("#myMarket").show();
        }
        
        //取的id
        function getIDFromClient() {
        	let id = JSON.parse(localStorage.getItem("client_id"));
        	
        	id = !id ? new Array() : id;
        	
        	return [id];
        }

        function getisSellerFromClient() {
            let isSeller = JSON.parse(localStorage.getItem("client_isSeller"));

            isSeller = !isSeller ? new Array() : isSeller;

            return [isSeller];
        }

        /**
         * 取得所有商品
         * @call：addProduct()：畫出一筆商品
         * @call：setButtonFunction()：按鈕設置
         * @call：checkIfExistInCart()：
         */
        function getAllProduct() {
            $.ajax({
                type: "GET",
                url: "api/product.do",
                crossDomain: true,
                cache: false,
                dataType: 'json',
                timeout: 5000,
                success: function (response) {
                    if (response.status == 200) {
                        var product_panel = '';

                        $.each(response.response.data, function () {
                        	//賣家不能買自己的產品
                        	if(this.sellerID!=parseInt(client_id.toString()))
                        		{
                        		 product_panel += addProduct(this);
                        		}
                           
                        })

                        $("#product_panel").append(product_panel);
                        
                       
                        
                        setButtonFunction();
                        checkIfExistInCart();
                        if(client_isSeller.length==0){
                         	//console.log("Hi")
                         	$('.productcard').attr('disabled', true);
                         }
                    }
                    console.log(response);
                },
                error: function () {
                    alert("無法連線到伺服器！");
                }
            });
        }

        getAllProduct();
        
 $(document).ready(function () {
        	
	
        });
        

        /**
         * 畫出一筆商品
         */
        function addProduct(data) {
            let inner_html = '';
            
            
            inner_html += '<div class="col-md-4" style="float:left;">';
            inner_html += '<div class="card-header">';
            inner_html += '<h4 class="font-weight-normal text-center text-truncate">' + data.product_name + '</h4>';
            inner_html += '</div>';
            inner_html += '<div class="card mb-4 shadow-sm">';
            inner_html += '<img src="' + data.image + '" height="200px" width="200px" hspace="50px">';
            inner_html += '<div class="card-body">';
			
            	productidname="anly"+data.idtbl_product;
				inner_html += "<div title='"+data.product_name+"' id='"+productidname+"' style='width:300px;height=10000px; padding: 0.5em;  display: none;'>"
				
				
				
				//詳細資料
				inner_html += '<img src="' + data.image + '" height="200px" width="200px" hspace="50px">';
				inner_html += '<div>產品簡介:<br>'+data.product_info+'</div>';
	            inner_html += '<h1 class="card-title pricing-card-title">$' + data.price + ' <small class="text-muted">/ USD</small></h1>';
//	            inner_html += '<p class="card-text">' + data.product_info + '</p>';
	            inner_html += '<div class="d-flex justify-content-between align-items-center">';
	            inner_html += '<div class="btn-group">';
//	            inner_html += '<button id="add_cart_' + data.idtbl_product + '" name="add_cart" type="button" class="productcard">加入購物車</button>'
          		inner_html +='</div></div></div>';
	            
	            inner_html += "<a href='javascript: setProductDetail("+data.idtbl_product+");'"+">產品詳細</a>";

            
            
            inner_html += '<h1 class="card-title pricing-card-title">$' + data.price + ' <small class="text-muted">/ USD</small></h1>';
            inner_html += '<p class="card-text">' + data.product_info + '</p>';
            inner_html += '<div class="d-flex justify-content-between align-items-center">';
            inner_html += '<div class="btn-group">';
            inner_html += '<button id="add_cart_' + data.idtbl_product + '" name="add_cart" type="button" class="productcard">加入購物車</button>';
            inner_html += '</div><small class="text-muted">id: ' + data.idtbl_product + '</small>';
            inner_html += '</div></div></div></div>';

            return inner_html;
        }

        /**
         * 按鈕設置：如果按了，就新增一筆資料到 cookie
         * 當按下任意一個「加入購物車」的按鈕後：呼叫addProductToCart()，把此商品加入購物車。
         * @call：addProductToCart()：
         */
         function setProductDetail( id){

        	var str="#anly"+id

        	$(str).dialog({autoOpen: true, show:{effect:'drop', direction:'right', duration: 1500}, width: '330', height: '450', resizable: false});
        }
         
         
        function setButtonFunction() {
            $('button[name="add_cart"]').click(function () {
                var action = (this.id).split('_')[0];
                var destination = (this.id).split('_')[1];
                var id = (this.id).split('_')[2];
                addProductToCart(id, 1);
            });
        }

        /**
         * 從 Client 端的 localstorage 取回儲存於購物車資訊
         */
        function getCartDataFromClient() {
            let cart = JSON.parse(localStorage.getItem("client_cart_obj"));
            let amount = JSON.parse(localStorage.getItem("client_cart_amount"));
            cart = !cart ? new Array() : cart;
            amount = !amount ? new Array() : amount;
            return [cart, amount];
        }

        /**
         * 新增一筆 cookie 
         * 將此商品加入購物車：如果還沒買過此商品 ( 即 client_cart_obj 內沒有此id)，就新增一筆，就把此商品存放到 cookie [client_cart_obj,client_cart_amount]
         * @call：updateCartDataToClent()：上傳二維陣列到 cookie 中
         * @call：checkIfExistInCart()：
         */
        function addProductToCart(id, amount) {
            if (!(client_cart_obj.includes(id))) {
                client_cart_obj.push(id);
                client_cart_amount.push(amount);
                updateCartDataToClent();
            }
            checkIfExistInCart();
        }

        /**
         * 更新購物車資料到 localstorage
         * 把存在二維陣列的資料，上傳到 cookie 中。
         *（localStorage即cookie：刷新頁面後不會消失，會暫存一段時間。相反地，二維陣列再刷新頁面後會消失。所以得把二維陣列裡的資料上傳到localStorage）
         */
        function updateCartDataToClent() {
            localStorage.setItem("client_cart_obj", JSON.stringify(client_cart_obj));
            localStorage.setItem("client_cart_amount", JSON.stringify(client_cart_amount));
        }

        /**
         * 檢查商品是否已經在購物車當中
         * @call：setButtonState：
         */
        function checkIfExistInCart() {
            $('button[name="add_cart"]').each(function () {
                var action = (this.id).split('_')[0];
                var destination = (this.id).split('_')[1];
                var id = (this.id).split('_')[2];
                if (client_cart_obj.includes(id)) {
                    setButtonState(this.id, false);
                }
                else {
                    setButtonState(this.id, true);
                }

            });
        }

        /**
         * 設定按鈕狀態
         */
        function setButtonState(id, action) {
            if (!action) {
                $('#' + id).prop('disabled', true);
                $('#' + id).addClass('disabled');
                $('#' + id).html('已加入');
            }
            else {
                $('#' + id).prop('disabled', false);
                $('#' + id).removeClass('disabled');
                $('#' + id).html('加入購物車');
            }
        }

        /*------------登入登出實作member cookie-----------*/

        var [client_id, client_name, client_isSeller] = getMemberDataFromClient();
        var [manager_id, manager_name, manager_isLeader] = getManagerDataFromClient();
        function getMemberDataFromClient() {
            let id = JSON.parse(localStorage.getItem("client_id"));
            let name = JSON.parse(localStorage.getItem("client_name"));
            let isSeller = JSON.parse(localStorage.getItem("client_isSeller"));

            id = !id ? new Array() : id;
            name = !name ? new Array() : name;
            isSeller = !isSeller ? new Array() : isSeller;
            return [id, name, isSeller];
        }
        function getManagerDataFromClient() {
            let id = JSON.parse(localStorage.getItem("manager_id"));
            let name = JSON.parse(localStorage.getItem("manager_name"));
            let isLeader = JSON.parse(localStorage.getItem("manager_isLeader"));

            id = !id ? new Array() : id;
            name = !name ? new Array() : name;
            isLeader = !isLeader ? new Array() : isLeader;
            return [id, name, isLeader];
        }

        function updateMemberDataToClent() {
            localStorage.setItem("client_id", JSON.stringify(client_id));
            localStorage.setItem("client_name", JSON.stringify(client_name));
            localStorage.setItem("client_isSeller", JSON.stringify(client_isSeller));
            localStorage.setItem("client_cart_obj", JSON.stringify(client_cart_obj));
            localStorage.setItem("client_cart_amount", JSON.stringify(client_cart_amount));

        }
        function updateManagerDataToClent() {
            localStorage.setItem("manager_id", JSON.stringify(manager_id));
            localStorage.setItem("manager_name", JSON.stringify(manager_name));
            localStorage.setItem("manager_isLeader", JSON.stringify(manager_isLeader));
        }

        function loguot() {
            client_id = [];
            client_name = [];
            updateMemberDataToClent();
            client_isSeller = [];
            client_cart_obj = [];
            client_cart_amount = [];
            updateMemberDataToClent();//有點奇怪，指呼叫一次的話不能刪乾淨，所以呼叫兩次updateMemberDataToClent
            $("#member_center1").hide();
            $("#member_center2").hide();
            $("#member_center3").hide();
            $("#member_center4").hide();
            $("#member_center5").hide();
            $("#shopcart").hide();
            $("#track").hide();
            $("#mymarket").hide();            
            $("#signup_in").show();
            $("#user_name").empty();
        }

        $("#remove").click(function () {
            console.log("[@Action]登出");
            loguot();
        });

        $(document).ready(function () {
        	setButtonFunction();
        	if(client_id.length != 0) {//登入會員
                $("#user_name").html(client_name);
                $("#member_center1").show();
                $("#member_center2").show();
                $("#member_center3").show();
                $("#member_center4").show();
                $("#member_center5").show();
                $("#signup_in").hide();
            }else if(manager_id.length != 0) {//登入管理員
                $("#user_name").html(manager_name);
                $("#member_center1").hide();
                $("#member_center").hide();//隱藏會員中心
                $("#member_center2").hide();
                $("#member_center3").show();
                $("#shopcart").hide();
                $("#track").hide();
                $("#mymarket").hide();
                
                $("#signup_in").hide();
            }else { //登出
            	$("#user_name").hide();
                $("#member_center1").hide();
                $("#member_center2").hide();
                $("#member_center3").hide();
                $("#member_center4").hide();
                $("#member_center5").hide();
                $("#shopcart").hide();
                $("#track").hide();
                $("#mymarket").hide();
            } 
        });

        /*----------------------------------------*/
    </script>

		<footer class="text-muted">
			<div class="container">
				<p class="float-right">
					<a href="#">Back to top</a>
				</p>
			</div>
		</footer>
</body>

</html>