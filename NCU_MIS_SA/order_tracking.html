<!DOCTYPE html>
<html>

<head>
	<title>OrderTracking</title>
	  	<!-- Bootstrap core CSS -->
	    <link href="statics/css/bootstrap.min.css" rel="stylesheet">
	    <link href="statics/css/font-awesome.min.css" rel="stylesheet">
	    <link href="statics/css/jquery-confirm.css" rel="stylesheet">
	    <link href="statics/icon/favicon.ico" type="image/x-icon" rel="icon">
	    <link href="statics/icon/favicon.ico" type="image/x-icon" rel="shortcut icon">
	    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">
    
    <style>
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        input:checked+.slider {
            background-color: #2196F3;
        }
        input:focus+.slider {
            box-shadow: 0 0 1px #2196F3;
        }
        input:checked+.slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
        /* Rounded sliders */
        .slider.round {
            border-radius: 34px;
        }
        .slider.round:before {
            border-radius: 50%;
        }
        
        .box2 {
            width: 600px;
            height: 400px;
            position: absolute;
            left: 50%;
            top: 50%;
            margin-top: -200px;
            margin-left: -300px;
        }
        .button {
            background-color: #FF8787;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            border-radius: 10px;
        }
        .button:hover {
            background-color: #f44336;
            color: white;
        }
     .orderstatus{
        	width: 800px;
            height: 300px;
            position: fixed;
            left: 50%;
            top: 60%;
            margin-top: -260px;
            margin-left: -400px;
			border: 0px solid #000;			
			background: #FBEE98;
			border-radius: 20px;
			z-index: 1;
		}
	 .ordertrackingtable{
			width: 800px;            
            position: absolute;
            left: 50%;
            top: 80%;
            margin-top: -70px;
            margin-left: -400px;			
			border-radius: 20px;
	}   
	.fixTableDiv {
			
			width: 800px;            
            position: fixed;
            left: 50%;
            top: 80%;
            margin-top: -20px;
            margin-left: -400px;			
			border-radius: 20px;		
	}
    table#table tr:hover {
    		background:#FBEE98;
    }
   
    
    </style>
    
    <link rel="stylesheet" href="statics/css/navbar.css">
    <link rel="stylesheet" href="statics/css/themebox.css">
    <link rel="stylesheet" href="statics/css/order_tracking.css">
      
     <script src="statics/js/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
      <script src="statics/js/jquery-confirm.js"></script>
</head>

<body bgcolor="#BCE2FF">
  	<ul class="navbar">
		<li class="navbar"><a href="index.html"><img src="statics/img/navbar/icon.png" style="float: left" height="100px" width="100px" ></img></a></li>
		<li class="navbar"><a class="navbarItem" href="index.html">Home</a></li>
		<li class="navbar"><a class="navbarItem" href="productIndex.html">商品總覽</a></li>
		<li class="navbar"><a id="orderTracking" class="navbarItem" href="order_tracking.html">訂單追蹤</a></li>
		<li class="navbar"><a id="shoppingcart" class="navbarItem" href="shoppingcart.html">購物車</a></li>
		<li class="navbar"><a id="myMarket" class="navbarItem" href="my_market.html">我的賣場</a></li>
		<li id="signup_in" style="float: right"><a class="navbarItemSide" href="login_selected.html">會員註冊/登入</a></li>
		<div id="member_center1" class="mediumbox" style="float: right">
			<li style="float: left"><a class="navbarFloating"
				href="member_change.html">會員中心</a></li>
			<li style="float: left"><a id="remove" class="navbarFloating"
				href="index.html">&nbsp;登出 </a></li>
			<li style="float: left">
	
		</div>
		<div id="member_center2" class="smallbox" style="float: right"> 
			<li><img src="statics/img/navbar/shoppingcart.png"
				style="float: left" height="20px" width="20px"></img></li>
			<li><a class="navbarFloating" href="shoppingcart.html">購物車</a></li>
		</div>
		<div id="member_center3" class="smallbox" style="float: right">
			<li><img src="statics/img/navbar/user.png" style="float: left"
				height="20px" width="20px"></img></li>
			<li id="user_name"class="navbarFloating">user</li>
		</div>
	</ul>
    <div class="orderstatus" style=" font-family:DFKai-sb;  color:blue" >
         <p style="font-size:20px; font-weight:300">&nbsp;&nbsp;訂單追蹤</p>
         
        
        		<table  style="width:100%" >
		            <thead style="text-align:left">
		                <tr>
		                		<th>訂單建立</th>			                	
			                	<th>到店寄件</th>			                	
			                    <th>抵達送件地點</th>  			                               
			                    <th>完成取貨</th>			                    		                    
		                </tr>
		            </thead>
		            <tbody style="align:center">
		            	<tr>
			            	<td><img src="statics/img/ordertrace/101952-200.png"  height="100px" width="100px"></img></td>
	                        <td><img src="statics/img/ordertrace/371293-200.png"  height="100px"  width="100px"></img></td>
	                        <td><img src="statics/img/ordertrace/e-commerce-29-512.png"  height="100px" width="100px"></img></td>
			                <td><img src="statics/img/ordertrace/Success-Place-Order-Complete-Shopping-Tick-512.png" height="100px" width="100px"></img></td>
                        </tr>
                        <tr>
                        	<td><img id="status1" src="statics/img/ordertrace/Ellipse 2.png"  height="40px" width="40px"></img></td>
                        	<td><img id="status2" src="statics/img/ordertrace/Ellipse 2.png"  height="40px" width="40px"></img></td>
                        	<td><img id="status3" src="statics/img/ordertrace/Ellipse 2.png"  height="40px" width="40px"></img></td>
                        	<td><img id="status4" src="statics/img/ordertrace/Ellipse 2.png"  height="40px" width="40px"></img></td>
                        </tr>
                        <tr>
                        	<td><p id="orderNO" style="color:black; text-align:center">&nbsp;&nbsp;訂單編號 </p></td>
                        	<td><button id="sent">已到店寄件</button></td>
                        	<td><button id="reached">已送達目標門市</button></td>
                        	<td><button id="finished">已收到商品</button></td>
                        </tr>
		            </tbody>
		        </table>
       
           
           
        </div>
        
	        <div class="ordertrackingtable">
		        <table  style="width:100%" id="table">
		            <thead>
		                <tr>
		                	<th>訂單詳細內容</th>
		                	<th>買進/賣出</th>
		                    <th>訂單編號</th>
		                    <th>商品總金額</th>
		                    <th>運送方式</th>                                      
		                    <th>訂單建立時間</th>
		                </tr>
		            </thead>
		            <tbody>
		            </tbody>
		        </table>
	        </div>
	 
 <script type="text/javascript">
 
 		var [client_isSeller] = getisSellerFromClient();
        var [client_cart_obj, client_cart_amount] = getCartDataFromClient();
		 
		 
		 $(document).ready(function() {
		     
		     $("#myMarket").hide();
		     $("#sent").hide();
		     $("#reached").hide();
		     $("#finished").hide();
        		if (parseInt(client_isSeller.toString()) == 1) {
            		$("#myMarket").show();
            		getMyBuyingOrder();
            		getMySellingOrder(); 
        		}             
        		else getMyBuyingOrder(); 
		 });
		 
		 function getCartDataFromClient() {
            let cart = JSON.parse(localStorage.getItem("client_cart_obj"));
            let amount = JSON.parse(localStorage.getItem("client_cart_amount"));
            cart = !cart ? new Array() : cart;
            amount = !amount ? new Array() : amount;
            return [cart, amount];
        }

        function getisSellerFromClient() {
            let isSeller = JSON.parse(localStorage.getItem("client_isSeller"));

            isSeller = !isSeller ? new Array() : isSeller;

            return [isSeller];
        }
		 
           function getMyBuyingOrder() {
        	   var [member_id,member_name]=getMemberDataFromClient();
               // 發出GET請求取得所有訂單列表
              
               $.ajax({
                       type: "GET",
                       url: "api/order.do",
                       crossDomain: true,
                       cache: false,
                       data: "memberID="+member_id,
                       dataType: 'json',
                       timeout: 50000,
                       success: function (response) {
                    	   console.log(response);
                           if(response.status == 200){
                               updateBuyingTable(response.response.data);
                               showOrderStatus(response.response.data);
                               //updateAndReturnOrderStatus(response.response.data);
                           }
                           
                       },
                       error: function () {
                           alert("無法連線到伺服器！");
                       }
               });               
           }
           function getMySellingOrder() {
        	   var [seller_id,member_name]=getMemberDataFromClient();
               // 發出GET請求取得所有訂單列表
              
               $.ajax({
                       type: "GET",
                       url: "api/order.do",
                       crossDomain: true,
                       cache: false,
                       data: "sellerID="+seller_id,
                       dataType: 'json',
                       timeout: 50000,
                       success: function (response) {
                    	   console.log(response);
                           if(response.status == 200){                               
                               updateSellingTable(response.response.data);
                               showOrderStatus(response.response.data);
                               //updateAndReturnOrderStatus(response.response.data);
                           }                           
                       },
                       error: function () {
                           alert("無法連線到伺服器！");
                       }
               });               
           }
           
       	   function showOrderStatus(data){
       		
       		   
       		$.each(data,function(index,val){
       			var detail_buyer="";
       			detail_buyer+="收件人："+val.order_info.buyer_name+"<br><br>";
       			
       			$.each(val.product_info,function(ind,v){
            		
            		detail_buyer+="商品名稱："+v.productID.product_name+"<br>";
            		detail_buyer+="商品單價："+v.price+"<br>";
            		detail_buyer+="商品數量："+v.product_quantities+"<br>";
            		detail_buyer+="單項小計："+v.subtotal+"<br><br>";
            		
            	})
       			detail_buyer+="寄送地址："+val.order_info.ship_address+"<br>";
       			
       			var id=data[index].order_info.idtbl_order;       			
       			var status=data[index].order_info.order_status; 	      			
       			$("#detail_"+id).click(function(){       
       				
             	   $.confirm({
                        theme: 'modern',
                        icon: 'fa fa-info-circle',
                        type: 'red',
                        animation: 'scale',
                        title: '詳細資訊',
                        content: detail_buyer,
                        buttons: {
                          	  確定: {
                                text: '確定',
                                btnClass: 'btn-red',
           
                                action: function () {                                    
                                    //document.location.href ="order_tracking.html";
                                }
                            }
                        }
                    })
                })
       			$("#order"+id).click(function(){
         		   
         		  	$("#orderNO").empty();
         		  	$("#sent").hide();
         			$("#reached").hide();
         			$("#finished").hide();
         			if(client_isSeller==1)
         			{	$("#sent").show();
             			$("#reached").show();}
         			else
         				$("#finished").show();
         		  $("#orderNO").append("訂單編號:"+id);
         		   	if(status==1)
         		   		for(var i=1;i<=4;i++){
         	           	   	if(i==1){
         	           		   document.getElementById("status"+i).src="statics/img/ordertrace/Ellipse 1.png";
         	           		   }
         	           	   else
         	           	   		document.getElementById("status"+i).src="statics/img/ordertrace/Ellipse 2.png";        	   
         	           	}
         			else if(status==2)
         				for(i=1;i<=4;i++){
         	           	   	if(i==2){
         	           		   document.getElementById("status"+i).src="statics/img/ordertrace/Ellipse 1.png";
         	           		   }
         	           	   else
         	           	   		document.getElementById("status"+i).src="statics/img/ordertrace/Ellipse 2.png";        	   
         	           	   }
         		   	else if(status==3)
         		   		for(i=1;i<=4;i++){
         	           	   	if(i==3){
         	           		   document.getElementById("status"+i).src="statics/img/ordertrace/Ellipse 1.png";
         	           		   }
         	           	   else
         	           	   	document.getElementById("status"+i).src="statics/img/ordertrace/Ellipse 2.png";        	   
         	           	   }
         		   	else if(status==4)
         		   		for(i=1;i<=4;i++){
         	           	   	if(i==4){
         	           		   document.getElementById("status"+i).src="statics/img/ordertrace/Ellipse 1.png";
         	           		   }
         	           	   else
         	           	   	document.getElementById("status"+i).src="statics/img/ordertrace/Ellipse 2.png";        	   
         	           	   }
         	   })
         	   
       	   })
       	   }
           function updateBuyingTable(data) {
               $("#table > tbody").empty();
                 //data是一個陣列，每一筆value包含了兩個物件---order_info和product_info
                 var table_html="";
               $.each(data, function(index, value) {
            	  
            	 //訂單編號連結的詳細資訊button
            	   table_html += '<tr id="order'+data[index].order_info.idtbl_order +'"><td scope="row" align="center"><button id="detail_'+ data[index].order_info.idtbl_order+'">查看訂單詳細內容</button></td>';
            	 //買進/賣出
            	   table_html += '<td align="center">買進</td>';
            	 //訂單編號
            	   table_html += '<td align="center">' + data[index].order_info.idtbl_order + '</td>';
            	 //訂單總金額
            	   table_html += '<td align="center">' + Math.round(data[index].order_info.total_price * 100) / 100 + '</td>';
                 //運送方式
            	   table_html += '<td align="center">' + data[index].order_info.product_delivery + '</td>';
                 //訂單建立時間
            	   table_html += '<td align="center">' + data[index].order_info.create+ '</td>';
                   
               })
               $("#table > tbody").append(table_html);
           }
           
          
           function updateSellingTable(data) {
                 //data是一個陣列，每一筆value包含了兩個物件---order_info和product_info
                 var orderIdentify=['買進','賣出'];
                 var table_html="";
               $.each(data, function(index, value) {
            	 //訂單編號連結的詳細資訊button
            	   table_html += '<tr id="order'+data[index].order_info.idtbl_order +'"><td scope="row" align="center"><button id="detail_'+ data[index].order_info.idtbl_order+'">查看訂單詳細內容</button></td>';
            	 //買進/賣出
            	   table_html += '<td align="center">賣出</td>';
            	 //訂單編號
            	   table_html += '<td align="center">' + data[index].order_info.idtbl_order + '</td>';
            	 //訂單總金額(該賣家應收帳款)
            	   table_html += '<td align="center">' + Math.round(data[index].order_info.total_price * 100) / 100 + '</td>';
                 //運送方式
            	   table_html += '<td align="center">' + data[index].order_info.product_delivery + '</td>';
                 //訂單建立時間
            	   table_html += '<td align="center">' + data[index].order_info.create+ '</td>';
                   
               })

               $("#table > tbody").append(table_html);
           }
           
           
           function updateAndReturnOrderStatus(){
        	   $.ajax({
                   type: "PUT",
                   url: "api/order.do",
                   crossDomain: true,
                   cache: false,
                   dataType: 'json',
                   timeout: 50000,
                   success: function (response) {
                	   console.log(response);
                       if(response.status == 200){
                           updateTable(response.response.data);
                           
                           showOrderStatus(response.response.data);
                          
                       }
                       console.log(response);
                   },
                   error: function () {
                       ///alert("無法連線到伺服器！");
                   }
           });
           }
           
         
           $("#sent").click(function(){
        	   
        	   for(var i=1;i<=4;i++){
        	   	if(i==2){
        		   document.getElementById("status"+i).src="statics/img/ordertrace/Ellipse 1.png";
        		   }
        	   else
        	   	document.getElementById("status"+i).src="statics/img/ordertrace/Ellipse 2.png";        	   
        	   }
        	});
           $("#reached").click(function(){
        	   for(var i=1;i<=4;i++){
           	   	if(i==3){
           		   document.getElementById("status"+i).src="statics/img/ordertrace/Ellipse 1.png";
           		   }
           	   else
           	   	document.getElementById("status"+i).src="statics/img/ordertrace/Ellipse 2.png";        	   
           	   }
           });
           $("#finished").click(function(){
        	   for(var i=1;i<=4;i++){
           	   	if(i==4){
           		   document.getElementById("status"+i).src="statics/img/ordertrace/Ellipse 1.png";
           		   }
           	   else
           	   	document.getElementById("status"+i).src="statics/img/ordertrace/Ellipse 2.png";        	   
           	   }
           });
           
           /*------------登入登出實作member cookie-----------*/
           
           var [client_id, client_name, client_isSeller]  = getMemberDataFromClient();

          function getMemberDataFromClient() {
          	let id = JSON.parse(localStorage.getItem("client_id"));
          	let name = JSON.parse(localStorage.getItem("client_name"));
          	let isSeller = JSON.parse(localStorage.getItem("client_isSeller"));

          	id = !id ? new Array() : id;
          	name = !name ? new Array() : name;
          	isSeller = !isSeller ? new Array() : isSeller;
          	return [id, name, isSeller];
          }
      	
           function updateMemberDataToClent() {
           	localStorage.setItem("client_id", JSON.stringify(client_id));
           	localStorage.setItem("client_name", JSON.stringify(client_name));
           	localStorage.setItem("client_isSeller", JSON.stringify(client_isSeller));
			localStorage.setItem("client_cart_obj", JSON.stringify(client_cart_obj));
            localStorage.setItem("client_cart_amount", JSON.stringify(client_cart_amount));
           }
          
          function loguot() {
            client_id = [];
            client_name = [];
            updateMemberDataToClent();
            client_isSeller = [];
            updateMemberDataToClent();//有點奇怪，指呼叫一次的話不能刪乾淨，所以呼叫兩次updateMemberDataToClent
            client_cart_obj = [];
            updateMemberDataToClent();
            client_cart_amount = [];
            updateMemberDataToClent();//有點奇怪，指呼叫一次的話不能刪乾淨，所以呼叫兩次updateMemberDataToClent
            $("#member_center1").hide();
            $("#member_center2").hide();
            $("#member_center3").hide();
            $("#signup_in").show();
            $("#user_name").empty();
          }
          
          $("#remove").click(function () {
           	console.log("[@Action]登出");
           	loguot();
           });
          
          $(document).ready(function(){
          	 if(client_id.length == 0){ //登出
          		 $("#member_center1").hide();
          	     $("#member_center2").hide();
          	     $("#member_center3").hide();
          	     $("#myMarket").hide();
          	     $("#orderTracking").hide();
          	     $("#shoppingcart").hide();
          	     $("#table").empty();
          	       
          	 }else{//登入
          		 $("#user_name").html(client_name);
             	 	 $("#member_center1").show();
             	 	 $("#member_center2").show();
             	     $("#member_center3").show();
             		 $("#signup_in").hide();
          	 }
          });
         
          /*----------------------------------------*/
       </script>
    




</body>

</html>