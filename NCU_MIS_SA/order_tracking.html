<!DOCTYPE html>
<html>

<head>
    <title>OrderTracking</title>
    <!-- Bootstrap core CSS -->
    <link href="statics/css/bootstrap.min.css" rel="stylesheet">
    <link href="statics/css/font-awesome.min.css" rel="stylesheet">
    <link href="statics/css/jquery-confirm.css" rel="stylesheet">
    <link href="statics/icon/favicon.ico" type="image/x-icon" rel="icon">
    <link href="statics/icon/favicon.ico" type="image/x-icon" rel="shortcut icon">
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">

    <style>
    nav.navbar fixed-top navbar-expand-lg navbar-light{
    	z-index:-1;
    }
    nav#navbar-example2{
    	z-index:1;	
    }
    </style>

    <script src="statics/js/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
    <script src="statics/js/jquery-confirm.js"></script>
</head>

<body>
	<div id="header">
		<!--容器分為左圖右導覽連結 -->
		<nav class="navbar fixed-top navbar-expand-lg navbar-light"	style="background-color: #e3f2fd;">
			<a class="navbar-brand" href="index.html"><img
				src="statics/img/navbar/icon.png" style="float: left" height="50px"
				width="50px"></img></a>
			<button class="navbar-toggler" type="button" data-toggle="collapse"
				data-target="#navbarColor03" aria-controls="navbarColor03"
				aria-expanded="true" aria-label="Toggle navigation">
				<span class="navbar-toggler-icon"></span>
			</button>

			<div class="navbar-collapse collapse show" id="navbarColor03"
				style="">
				<ul class="navbar-nav mr-auto">
					<li class="nav-item active"><a class="nav-link"
						href="index.html">Home <span class="sr-only">(current)</span></a></li>
					<li class="nav-item"><a class="nav-link"
						href="productIndex.html">商品總覽</a></li>
					<li class="nav-item"><a class="nav-link"
						href="order_tracking.html">訂單追蹤</a></li>
					<li class="nav-item"><a class="nav-link"
						href="shoppingcart.html">購物車</a></li>
					<li class="nav-item"><a class="nav-link" href="my_market.html">我的賣場</a>
					</li>
				</ul>

			</div>

			<ul class="navbar-nav mr-auto">
				<li class="nav-item"><img
					src="statics/img/navbar/shoppingcart.png" height="20px"
					width="20px"></img></li>
				<li><a class="nav-link" href="shoppingcart.html">購物車</a></li>


				<li id="signup_in" class="nav-item"><a class="nav-link"
					href="login_selected.html">會員註冊/登入</a></li>

				<li class="nav-item"><img src="statics/img/navbar/user.png"
					height="20px" width="20px"></img></li>
				<li id="user_name" class="nav-link">user</li>

				<li class="nav-item"><a id="member_center" class="nav-link"
					href="member_change.html">會員中心</a></li>

				<li class="nav-item"><a id="remove" class="nav-link"
					href="index.html">&nbsp;登出 </a></li>

			</ul>

			<form class="form-inline">
				<input class="form-control mr-sm-2" type="search"
					placeholder="Search" aria-label="Search">
				<button class="btn btn-outline-primary " type="submit">Search</button>
			</form>
		</nav>
    <nav id="navbar-example2" class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="#">訂單追蹤</a>
        <ul class="nav nav-pills">
            <li class="nav-item">
                <a class="nav-link" href="#all-order">買進</a>
            </li>
           
            <li class="nav-item">
                <a class="nav-link" href="#st" class="nav-link active">賣出</a>
            </li>
        </ul> 
    </nav>
   <nav id="navbar-example2" class="navbar navbar-light bg-light sticky-top">     
   	<a class="navbar-brand" href="#" id="orderNO"></a>           
        <table id="st" style="width:100%">
        <thead style="text-align:center">
            <tr>
                <th>訂單建立</th>
                <th>訂單處理中</th>
                <th>完成取貨</th>
            </tr>
        </thead>
        <tbody>
            <tr style="text-align:center">
            </tr>
        </tbody>
    </table>             
    </nav>
	 <div class="progress sticky-top">
        	<div id="status_progress" class="progress-bar" role="progressbar" style="width:0%;" aria-valuenow="0"
            aria-valuemin="0" aria-valuemax="100"></div>
    </div>
  
    <div id="all-order" data-spy="scroll" data-target="#navbar-example2" data-offset="50">
		 
		 <table class="table table-hover" id="table" style="align:center;width:100%;position: relative;" >
            <thead>
                <tr>
                    <th>訂單詳細內容</th>
                    <th>買進/賣出</th>
                    <th>訂單編號</th>
                    <th>商品總金額</th>
                    <th>運送方式</th>
                    <th>訂單建立時間</th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    </div>    
    <script type="text/javascript">
        var [client_isSeller] = getisSellerFromClient();
        var [client_cart_obj, client_cart_amount] = getCartDataFromClient();
        var [memberID,memberName]=getMemberDataFromClient();


        $(document).ready(function () {

            $("#myMarket").hide();
            //$("#started_"+id).hide();            
            //$("#finished_"+id).hide();
            if (parseInt(client_isSeller.toString()) == 1) {
                $("#myMarket").show();
            getMySellingOrder();
                getMyBuyingOrder();
            } else getMyBuyingOrder();
        });

        function getCartDataFromClient() {
            let cart = JSON.parse(localStorage.getItem("client_cart_obj"));
            let amount = JSON.parse(localStorage.getItem("client_cart_amount"));
            cart = !cart ? new Array() : cart;
            amount = !amount ? new Array() : amount;
            return [cart, amount];
        }

        function getisSellerFromClient() {
            let isSeller = JSON.parse(localStorage.getItem("client_isSeller"));

            isSeller = !isSeller ? new Array() : isSeller;

            return [isSeller];
        }

        function getMyBuyingOrder() {
            var [member_id, member_name] = getMemberDataFromClient();
            // 發出GET請求取得所有訂單列表

            $.ajax({
                type: "GET",
                url: "api/order.do",
                crossDomain: true,
                cache: false,
                data: "buyerID=" + member_id,
                dataType: 'json',
                timeout: 50000,
                success: function (response) {
                    console.log(response);
                    if (response.status == 200) {
                        updateBuyingTable(response.response.data);
                        showBuyingOrderStatus(response.response.data);
                        
                    }

                },
                error: function () {
                    alert("無法連線到伺服器！");
                }
            });
        }

        function getMySellingOrder() {
            var [seller_id, member_name] = getMemberDataFromClient();
            // 發出GET請求取得所有訂單列表

            $.ajax({
                type: "GET",
                url: "api/order.do",
                crossDomain: true,
                cache: false,
                data: "sellerID=" + seller_id,
                dataType: 'json',
                timeout: 50000,
                success: function (response) {
                	
                    console.log(response);
                    if (response.status == 200) {
                        updateSellingTable(response.response.data);
                        showSellingOrderStatus(response.response.data);
                        
                    }
                },
                error: function () {
                    alert("無法連線到伺服器！");
                }
            });
        }

        function updateBuyingTable(data) {
            $("#table > tbody").empty();
            //data是一個陣列，每一筆value包含了兩個物件---order_info和product_info
            var table_html = "";
            $.each(data, function (index, value) {

                //訂單編號連結的詳細資訊button
                table_html += '<tr id="order' + value.order_info.idtbl_order +
                    '"><td scope="row" align="center"><button class="btn btn-warning" id="detail_' + value.order_info.idtbl_order + '">查看訂單</button></td>';
                //買進/賣出
                table_html += '<td align="center">買進</td>';
                //訂單編號
                table_html += '<td align="center">' + value.order_info.idtbl_order + '</td>';
                //訂單總金額
                table_html += '<td align="center">' + Math.round(value.order_info.total_price * 100) / 100 +
                    '</td>';
                //運送方式
                table_html += '<td align="center">' + value.order_info.product_delivery + '</td>';
                //訂單建立時間
                table_html += '<td align="center">' + value.order_info.create + '</td>';

            })
            $("#table > tbody").append(table_html);
        }


        function updateSellingTable(data) {
            //data是一個陣列，每一筆value包含了兩個物件---order_info和product_info
           
            var table_html = "";
            $.each(data, function (index, value) {
            	
                //訂單編號連結的詳細資訊button
                table_html += '<tr name="row[]" id="order_' + value.orderID +
                    '"><td scope="row" align="center"><button class="btn btn-primary" id="detail_' + value.idtbl_orderproduct +
                    '">查看訂單</button></td>';
                //買進/賣出
                table_html += '<td align="center">賣出</td>';
                //訂單編號
                table_html += '<td align="center">' + value.orderID + '</td>';
                //訂單總金額(該賣家應收帳款)
                table_html += '<td align="center">' + Math.round(value.subtotal * 100) / 100 +
                    '</td>';
                //運送方式
                table_html += '<td align="center">' + value.product_delivery + '</td>';
                //訂單建立時間
                table_html += '<td align="center">' + value.create+ '</td>';
                
                table_html += '<td scope="row" align="center"><button class="btn btn-success" name="start[]" id="started_' + value.orderID +
                '">開始處理</button></td>';
                table_html += '<td scope="row" align="center"><button class="btn btn-success" name="finish[]" id="finished_' + value.orderID +
                '">完成訂單</button></td></tr>';
            })
            $("#table > tbody").append(table_html);
        
        }

        function showBuyingOrderStatus(data) {
            $.each(data, function (index, val) {
                var detail_buyer = "";
                detail_buyer += "收件人：" + val.order_info.buyer_name + "<br>";
                detail_buyer += "寄送地址：" + val.order_info.ship_address + "<br><br>";

                $.each(val.product_info, function (ind, v) {

                    detail_buyer += "商品名稱：" + v.productID.product_name + "<br>";
                    detail_buyer += "商品單價：" + v.price + "<br>";
                    detail_buyer += "商品數量：" + v.product_quantities + "<br>";
                    detail_buyer += "單項小計：" + v.subtotal + "<br><br>";

                })
                	detail_buyer += "付款方式：" + val.order_info.payment + "<br><br>";

                var id = data[index].order_info.idtbl_order;
                var status = data[index].order_info.order_status;
                var buyerID=data[index].order_info.memberID;                
                $("#detail_" + id).click(function () {
                	

                    $.confirm({
                        theme: 'modern',
                        icon: 'fa fa-info-circle',
                        type: 'red',
                        animation: 'scale',
                        title: '詳細資訊',
                        content: detail_buyer,
                        buttons: {
                            確定: {
                                text: '確定',
                                btnClass: 'btn-red',
                                action: function () {
                                    //document.location.href ="order_tracking.html";
                                }
                            }
                        }
                    })
                })
                $("#order" + id).click(function () {
				
                    $("#orderNO").empty();
                    $("#started_"+id).hide();                    
                    $("#finished_"+id).hide();
                    if (client_isSeller == 1) {
                        $("#started_"+id).show();                       
                    } else
                        $("#finished_"+id).show();
                    $("#orderNO").append("訂單編號:" + id);
                    if (status == 1 ) {
                    	document.getElementById("status_progress").style.width = "33%";
                    	if (client_isSeller==0 ){//BuyerID==memberID即代表此筆訂單一定是買進
                        	$("#finished_"+id).hide();//對買家而言，本來會顯示的按鈕為"完成訂單"，所以此處要隱藏起來
                    	} 
                    	else if(client_isSeller==1 && buyerID==memberID){
                    		$("#finished_"+id).hide();
                    		$("#started_"+id).hide();
                    	}
                    	
                    		
                    } 
                    else if (status == 2) {
                    	$("#started_"+id).hide();
                    	document.getElementById("status_progress").style.width = "67%";
                    	
                    	if(client_isSeller==1&&buyerID==memberID){
                    		$("#finished_"+id).show();
                    	}
                    	
                	} 
                    else if (status == 3) {
                        document.getElementById("status_progress").style.width = "100%";
                        $.alert("此訂單已完成");
                        if(client_isSeller==0){
                    		$("#finished_"+id).hide();
                    	}
                        else if(client_isSeller==1){
                    		$("#started_"+id).hide();
                    	}
                    } 
                    
                    
                    
                    
                })
			    	       
    		
            })
            

        }

        function showSellingOrderStatus(data) {
            $.each(data, function (index, val) {
                var detail_buyer = "";
                detail_buyer += "訂單編號：" + val.orderID + "<br><br>";
                detail_buyer +="購買者ID："+val.memberID+"<br>";                
                detail_buyer += "收件人：" + val.buyer_name + "<br>";
                detail_buyer += "連絡電話：" + val.cellphone + "<br>";
                detail_buyer += "寄送地址：" + val.ship_address + "<br><br>";
                
                //detail_buyer += "商品名稱：" + val.price + "<br>";
                detail_buyer += "商品單價：" + val.price + "<br>";
                detail_buyer += "商品數量：" + val.product_quantities + "<br>";
                detail_buyer += "單項小計：" + val.subtotal + "<br>";
                detail_buyer += "付款方式：" + val.payment;

                var id = val.orderID;
                var status = val.order_status;
                var idOrderProduct=val.idtbl_orderproduct;				
                var buyerID=val.memberID;
                
                $("#detail_" + idOrderProduct).click(function () {                	

                    $.confirm({
                        theme: 'modern',
                        icon: 'fa fa-info-circle',
                        type: 'red',
                        animation: 'scale',
                        title: '詳細資訊',
                        content: detail_buyer,
                        buttons: {
                            確定: {
                                text: '確定',
                                btnClass: 'btn-red',
                                action: function () {
                                    //document.location.href ="order_tracking.html";
                                }
                            }
                        }
                    })
                })
                
			    	       
    		
            })
            

        }
        
        
        function updateOrderStatus(status,orderID) {
        	
        	var data_object = {
        			"order_status":status,
                    "orderID":orderID                     
                };
                var data_string = JSON.stringify(data_object);

			
            $.ajax({
                type: "PUT",
                url: "api/order.do",
                crossDomain: true,
                cache: false,
                data:data_string,
                dataType: 'json',
                timeout: 50000,
                success: function (response) {
                    console.log(response);
                    if (response.status == 200) {   
                    	$.alert("水喔!")
                    }
                },
                error: function () {
                    	$.alert("幹");
                }
            });
        }

        
        
        
        
        //全域的ajax get
        $.ajax({
            type: "GET",
            url: "api/order.do",
            crossDomain: true,
            cache: false,
            data: "buyerID=" + memberID,
            dataType: 'json',
            timeout: 50000,
            success: function (response) {
                console.log(response);
                if (response.status == 200) {
                    
                    var status=response.response.data
                }
            },
            error: function () {
                alert("無法連線到伺服器！");
            }
        });
        //function ReturnOrderStatus(id){
        	 ///var order_status=response.response.data[`]
        	//return order_status;
        //}
        
        //function ReturnMemberID(rID){
        	
       // }
        
        $('button[name="start[]"').hide();
        $('button[name="finish[]"').hide(); 
        
        //開始處理按鈕觸發事件
        $('button[name="start[]"').click(function() {        	
        	var sID = (this.id).split('_')[1];
        	
        	$.confirm({
            	title: '開始處理訂單',
        	    content: '準備好就開始吧!',
        	    buttons: {
        	        確認: function () {
        	        	document.getElementById("status_progress").style.width = "67%";
        	        	$("#started_"+sID).hide();
        	        	
        	        	updateOrderStatus(2,sID);
        	        	
        	        },
        	        取消: function () {
        	        }
        	    }
            });
        	
        });
      //完成訂單按鈕觸發事件
        $('button[name="finish[]"').click(function() {
        	var fID = (this.id).split('_')[1];
        	alert(fID);
        	$.confirm({
        	    title: '即將完成訂單',
        	    content: '請確認是否收到商品!',
        	    buttons: {
        	        確認: function () {
        	        	document.getElementById("status_progress").style.width = "100%";
        	        	$("#finished_"+fID).hide();        	        	
        	        	updateOrderStatus(3,fID);
        	        },
        	        取消: function () {
        	        }
        	    }
        	});
        });
        
     //if (parseInt(client_isSeller.toString()) == 1) {
        	 //$('button[name="start[]"').show();}
   // else{
        	//$('button[name="finish[]"').show();}
        
        
      
       
        
        $('tr[name="row[]"').click(function() {
        	var rID = (this.id).split('_')[1];
        	alert(rID);
        	var status=ReturnOrderStatus(rID);
        	var memberID=ReturnMemberID(rID);
            $("#orderNO").empty();  
            $("#orderNO").append("訂單編號:" + rID);
            
            if (status == 1 ) {
            	document.getElementById("status_progress").style.width = "33%";
            	if (client_isSeller==0 ){//BuyerID==memberID即代表此筆訂單一定是買進
                	$("#finished_"+rID).hide();//對買家而言，本來會顯示的按鈕為"完成訂單"，所以此處要隱藏起來
            	} 
            	else if(client_isSeller==1 && buyerID==memberID){
            		$("#finished_"+rID).hide();
            		$("#started_"+rID).hide();
            	}
            } 
            else if (status == 2) {
            	$("#started_"+rID).hide();
            	document.getElementById("status_progress").style.width = "67%";
            	
            	if(client_isSeller==1&&buyerID==memberID){
            		$("#finished_"+rID).show();
            	}
            	
        	} 
            else if (status == 3) {
                document.getElementById("status_progress").style.width = "100%";
                $.alert("此訂單已完成");
                if(client_isSeller==0){
            		$("#finished_"+rID).hide();
            	}
                else if(client_isSeller==1){
            		$("#started_"+rID).hide();
            	}
            } 
        })

		            

	  
        

        /*------------登入登出實作member cookie-----------*/

        var [client_id, client_name, client_isSeller] = getMemberDataFromClient();

        function getMemberDataFromClient() {
            let id = JSON.parse(localStorage.getItem("client_id"));
            let name = JSON.parse(localStorage.getItem("client_name"));
            let isSeller = JSON.parse(localStorage.getItem("client_isSeller"));

            id = !id ? new Array() : id;
            name = !name ? new Array() : name;
            isSeller = !isSeller ? new Array() : isSeller;
            return [id, name, isSeller];
        }

        function updateMemberDataToClent() {
            localStorage.setItem("client_id", JSON.stringify(client_id));
            localStorage.setItem("client_name", JSON.stringify(client_name));
            localStorage.setItem("client_isSeller", JSON.stringify(client_isSeller));
            localStorage.setItem("client_cart_obj", JSON.stringify(client_cart_obj));
            localStorage.setItem("client_cart_amount", JSON.stringify(client_cart_amount));
        }

        function loguot() {
            client_id = [];
            client_name = [];
            updateMemberDataToClent();
            client_isSeller = [];
            updateMemberDataToClent(); //有點奇怪，指呼叫一次的話不能刪乾淨，所以呼叫兩次updateMemberDataToClent
            client_cart_obj = [];
            updateMemberDataToClent();
            client_cart_amount = [];
            updateMemberDataToClent(); //有點奇怪，指呼叫一次的話不能刪乾淨，所以呼叫兩次updateMemberDataToClent
            $("#member_center1").hide();
            $("#member_center2").hide();
            $("#member_center3").hide();
            $("#signup_in").show();
            $("#user_name").empty();
        }

        $("#remove").click(function () {
            console.log("[@Action]登出");
            loguot();
        });

        $(document).ready(function () {
            if (client_id.length == 0) { //登出
                $("#member_center1").hide();
                $("#member_center2").hide();
                $("#member_center3").hide();
                $("#myMarket").hide();
                $("#orderTracking").hide();
                $("#shoppingcart").hide();
                $("#table").empty();

            } else { //登入
                $("#user_name").html(client_name);
                $("#member_center1").show();
                $("#member_center2").show();
                $("#member_center3").show();
                $("#signup_in").hide();
            }
        });

        /*----------------------------------------*/
    </script>





</body>

</html>