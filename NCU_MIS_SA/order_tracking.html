<!DOCTYPE html>
<html>

<head>
    <title>OrderTracking</title>
    <!-- Bootstrap core CSS -->
    <link href="statics/css/bootstrap.min.css" rel="stylesheet">
    <link href="statics/css/font-awesome.min.css" rel="stylesheet">
    <link href="statics/css/jquery-confirm.css" rel="stylesheet">
    <link href="statics/icon/favicon.ico" type="image/x-icon" rel="icon">
    <link href="statics/icon/favicon.ico" type="image/x-icon" rel="shortcut icon">
    <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1">

    <style>
    </style>

    <script src="statics/js/jquery-3.4.1.min.js" crossorigin="anonymous"></script>
    <script src="statics/js/jquery-confirm.js"></script>
</head>

<body bgcolor="#BCE2FF">
    <ul class="navbar">
        <li><a href="index.html"><img src="statics/img/navbar/icon.png" style="float: left" height="100px"
                    width="100px"></img></a></li>
        <li><a class="navbarItem" href="index.html">Home</a></li>
        <li><a class="navbarItem" href="productIndex.html">商品總覽</a></li>
        <li><a id="orderTracking" href="order_tracking.html">訂單追蹤</a></li>
        <li><a id="shoppingcart" href="shoppingcart.html">購物車</a></li>
        <li><a id="myMarket" href="my_market.html">我的賣場</a></li>
        <li id="signup_in" style="float: right"><a href="login_selected.html">會員註冊/登入</a></li>
        <div id="member_center1" style="float: right">
            <li style="float: left"><a href="member_change.html">會員中心</a></li>
            <li style="float: left"><a id="remove" href="index.html">&nbsp;登出 </a></li>
            <li style="float: left">

        </div>
        <div id="member_center2">
            <li><img src="statics/img/navbar/shoppingcart.png" style="float: left" height="20px" width="20px"></img>
            </li>
            <li><a href="shoppingcart.html">購物車</a></li>
        </div>
        <div id="member_center3" style="float: right">
            <li><img src="statics/img/navbar/user.png" style="float: left" height="20px" width="20px"></img></li>
            <li id="user_name">user</li>
        </div>
    </ul>
    <nav id="navbar-example2" class="navbar navbar-light bg-light">
        <a class="navbar-brand" href="#">訂單追蹤</a>
        <ul class="nav nav-pills">
            <li class="nav-item">
                <a class="nav-link" href="#all-order">買進</a>
            </li>
           
            <li class="nav-item">
                <a class="nav-link" href="#st" class="nav-link active">賣出</a>
            </li>
        </ul> 
    </nav>
   <nav id="navbar-example2" class="navbar navbar-light bg-light sticky-top">     
   	<a class="navbar-brand" href="#" id="orderNO"></a>           
        <table id="st" style="width:100%">
        <thead style="text-align:center">
            <tr>
                <th>訂單建立</th>
                <th>訂單處理中</th>
                <th>完成取貨</th>
            </tr>
        </thead>
        <tbody>
            <tr style="text-align:center">
                <td></td>
                <td><button class="btn btn-success" id="started">開始處理</button></td>
                <td><button class="btn btn-success" id="finished">已收到商品</button></td>
            </tr>
        </tbody>
    </table>             
    </nav>
	 <div class="progress sticky-top">
        	<div id="status_progress" class="progress-bar" role="progressbar" style="width:0%;" aria-valuenow="0"
            aria-valuemin="0" aria-valuemax="100"></div>
    </div>
  
    <div id="all-order" data-spy="scroll" data-target="#navbar-example2" data-offset="50">
		 
		 <table class="table table-hover" id="table" style="align:center;width:100%;position: relative;" >
            <thead>
                <tr>
                    <th>訂單詳細內容</th>
                    <th>買進/賣出</th>
                    <th>訂單編號</th>
                    <th>商品總金額</th>
                    <th>運送方式</th>
                    <th>訂單建立時間</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>    
    <script type="text/javascript">
        var [client_isSeller] = getisSellerFromClient();
        var [client_cart_obj, client_cart_amount] = getCartDataFromClient();
        var [memberID,memberName]=getMemberDataFromClient();


        $(document).ready(function () {

            $("#myMarket").hide();
            $("#started").hide();
            $("#reached").hide();
            $("#finished").hide();
            if (parseInt(client_isSeller.toString()) == 1) {
                $("#myMarket").show();
                getMySellingOrder();
                getMyBuyingOrder();
            } else getMyBuyingOrder();
        });

        function getCartDataFromClient() {
            let cart = JSON.parse(localStorage.getItem("client_cart_obj"));
            let amount = JSON.parse(localStorage.getItem("client_cart_amount"));
            cart = !cart ? new Array() : cart;
            amount = !amount ? new Array() : amount;
            return [cart, amount];
        }

        function getisSellerFromClient() {
            let isSeller = JSON.parse(localStorage.getItem("client_isSeller"));

            isSeller = !isSeller ? new Array() : isSeller;

            return [isSeller];
        }

        function getMyBuyingOrder() {
            var [member_id, member_name] = getMemberDataFromClient();
            // 發出GET請求取得所有訂單列表

            $.ajax({
                type: "GET",
                url: "api/order.do",
                crossDomain: true,
                cache: false,
                data: "buyerID=" + member_id,
                dataType: 'json',
                timeout: 50000,
                success: function (response) {
                    console.log(response);
                    if (response.status == 200) {
                        updateBuyingTable(response.response.data);
                        showOrderStatus(response.response.data);
                        
                    }

                },
                error: function () {
                    alert("無法連線到伺服器！");
                }
            });
        }

        function getMySellingOrder() {
            var [seller_id, member_name] = getMemberDataFromClient();
            // 發出GET請求取得所有訂單列表

            $.ajax({
                type: "GET",
                url: "api/order.do",
                crossDomain: true,
                cache: false,
                data: "sellerID=" + seller_id,
                dataType: 'json',
                timeout: 50000,
                success: function (response) {
                    console.log(response);
                    if (response.status == 200) {
                        updateSellingTable(response.response.data);
                        showOrderStatus(response.response.data);
                        
                    }
                },
                error: function () {
                    alert("無法連線到伺服器！");
                }
            });
        }

        function updateBuyingTable(data) {
            $("#table > tbody").empty();
            //data是一個陣列，每一筆value包含了兩個物件---order_info和product_info
            var table_html = "";
            $.each(data, function (index, value) {

                //訂單編號連結的詳細資訊button
                table_html += '<tr id="order' + value.order_info.idtbl_order +
                    '"><td scope="row" align="center"><button class="btn btn-warning" id="detail_' + value.order_info.idtbl_order + '">查看訂單</button></td>';
                //買進/賣出
                table_html += '<td align="center">買進</td>';
                //訂單編號
                table_html += '<td align="center">' + value.order_info.idtbl_order + '</td>';
                //訂單總金額
                table_html += '<td align="center">' + Math.round(value.order_info.total_price * 100) / 100 +
                    '</td>';
                //運送方式
                table_html += '<td align="center">' + value.order_info.product_delivery + '</td>';
                //訂單建立時間
                table_html += '<td align="center">' + value.order_info.create + '</td>';

            })
            $("#table > tbody").append(table_html);
        }


        function updateSellingTable(data) {
            //data是一個陣列，每一筆value包含了兩個物件---order_info和product_info
            var orderIdentify = ['買進', '賣出'];
            var table_html = "";
            $.each(data, function (index, value) {
                //訂單編號連結的詳細資訊button
                table_html += '<tr id="order' + value.order_info.idtbl_order +
                    '"><td scope="row" align="center"><button class="btn btn-primary" id="detail_' + value.order_info.idtbl_order +
                    '">查看訂單</button></td>';
                //買進/賣出
                table_html += '<td align="center">賣出</td>';
                //訂單編號
                table_html += '<td align="center">' + value.order_info.idtbl_order + '</td>';
                //訂單總金額(該賣家應收帳款)
                table_html += '<td align="center">' + Math.round(value.order_info.total_price * 100) / 100 +
                    '</td>';
                //運送方式
                table_html += '<td align="center">' + value.order_info.product_delivery + '</td>';
                //訂單建立時間
                table_html += '<td align="center">' + value.order_info.create + '</td>';

            })

            $("#table > tbody").append(table_html);
        }

        function showOrderStatus(data) {
            $.each(data, function (index, val) {
                var detail_buyer = "";
                detail_buyer += "收件人：" + val.order_info.buyer_name + "<br><br>";

                $.each(val.product_info, function (ind, v) {

                    detail_buyer += "商品名稱：" + v.productID.product_name + "<br>";
                    detail_buyer += "商品單價：" + v.price + "<br>";
                    detail_buyer += "商品數量：" + v.product_quantities + "<br>";
                    detail_buyer += "單項小計：" + v.subtotal + "<br><br>";

                })
                detail_buyer += "寄送地址：" + val.order_info.ship_address + "<br>";

                var id = data[index].order_info.idtbl_order;
                var status = data[index].order_info.order_status;
                var buyerID=data[index].order_info.memberID;                
                $("#detail_" + id).click(function () {
                	

                    $.confirm({
                        theme: 'modern',
                        icon: 'fa fa-info-circle',
                        type: 'red',
                        animation: 'scale',
                        title: '詳細資訊',
                        content: detail_buyer,
                        buttons: {
                            確定: {
                                text: '確定',
                                btnClass: 'btn-red',
                                action: function () {
                                    //document.location.href ="order_tracking.html";
                                }
                            }
                        }
                    })
                })
                $("#order" + id).click(function () {
				
                    $("#orderNO").empty();
                    $("#started").hide();                    
                    $("#finished").hide();
                    if (client_isSeller == 1) {
                        $("#started").show();                       
                    } else
                        $("#finished").show();
                    $("#orderNO").append("訂單編號:" + id);
                    if (status == 1 ) {
                    	document.getElementById("status_progress").style.width = "33%";
                    	if (client_isSeller==0 ){//BuyerID==memberID即代表此筆訂單一定是買進
                        	$("#finished").hide();//對買家而言，本來會顯示的按鈕為"完成訂單"，所以此處要隱藏起來
                    	} 
                    	else if(client_isSeller==1 && buyerID==memberID){
                    		$("#finished").hide();
                    		$("#started").hide();
                    	}
                    	
                    		
                    } 
                    else if (status == 2) {
                    	$("#started").hide();
                    	document.getElementById("status_progress").style.width = "67%";
                    	
                    	if(client_isSeller==1&&buyerID==memberID){
                    		$("#finished").show();
                    	}
                    	
                	} 
                    else if (status == 3) {
                        document.getElementById("status_progress").style.width = "100%";
                        $.alert("此訂單已完成");
                        if(client_isSeller==0){
                    		$("#finished").hide();
                    	}
                        else if(client_isSeller==1){
                    		$("#started").hide();
                    	}
                    } 
                    
                    
                    
                    
                })
			    	       
    		
            })
            

        }

        $("#started").click(function () {
            
            $.confirm({
            	title: '開始處理訂單',
        	    content: '準備好就開始吧!',
        	    buttons: {
        	        確認: function () {
        	        	document.getElementById("status_progress").style.width = "67%";
        	        	$("#started").hide();
        	        	//status=2;
        	        	//updateOrderStatus(status,id);
        	        	
        	        },
        	        取消: function () {
        	        }
        	    }
            });
       })
        $("#finished").click(function () {
          
          $.confirm({
        	    title: '即將完成訂單',
        	    content: '請確認是否收到商品!',
        	    buttons: {
        	        確認: function () {
        	        	document.getElementById("status_progress").style.width = "100%";
        	        	$("#finished").hide();
        	        	//status=3;
        	        	//updateOrderStatus(status,id);
        	        },
        	        取消: function () {
        	        }
        	    }
        	});
       })

        

        /*------------登入登出實作member cookie-----------*/

        var [client_id, client_name, client_isSeller] = getMemberDataFromClient();

        function getMemberDataFromClient() {
            let id = JSON.parse(localStorage.getItem("client_id"));
            let name = JSON.parse(localStorage.getItem("client_name"));
            let isSeller = JSON.parse(localStorage.getItem("client_isSeller"));

            id = !id ? new Array() : id;
            name = !name ? new Array() : name;
            isSeller = !isSeller ? new Array() : isSeller;
            return [id, name, isSeller];
        }

        function updateMemberDataToClent() {
            localStorage.setItem("client_id", JSON.stringify(client_id));
            localStorage.setItem("client_name", JSON.stringify(client_name));
            localStorage.setItem("client_isSeller", JSON.stringify(client_isSeller));
            localStorage.setItem("client_cart_obj", JSON.stringify(client_cart_obj));
            localStorage.setItem("client_cart_amount", JSON.stringify(client_cart_amount));
        }

        function loguot() {
            client_id = [];
            client_name = [];
            updateMemberDataToClent();
            client_isSeller = [];
            updateMemberDataToClent(); //有點奇怪，指呼叫一次的話不能刪乾淨，所以呼叫兩次updateMemberDataToClent
            client_cart_obj = [];
            updateMemberDataToClent();
            client_cart_amount = [];
            updateMemberDataToClent(); //有點奇怪，指呼叫一次的話不能刪乾淨，所以呼叫兩次updateMemberDataToClent
            $("#member_center1").hide();
            $("#member_center2").hide();
            $("#member_center3").hide();
            $("#signup_in").show();
            $("#user_name").empty();
        }

        $("#remove").click(function () {
            console.log("[@Action]登出");
            loguot();
        });

        $(document).ready(function () {
            if (client_id.length == 0) { //登出
                $("#member_center1").hide();
                $("#member_center2").hide();
                $("#member_center3").hide();
                $("#myMarket").hide();
                $("#orderTracking").hide();
                $("#shoppingcart").hide();
                $("#table").empty();

            } else { //登入
                $("#user_name").html(client_name);
                $("#member_center1").show();
                $("#member_center2").show();
                $("#member_center3").show();
                $("#signup_in").hide();
            }
        });

        /*----------------------------------------*/
    </script>





</body>

</html>